---
title: "따릉이 데이터 분석"
output: html_notebook
---
####  R-notebook 조작법
실행 : **Ctrl+Shift+Enter**  
코드 : **Ctrl+Alt+I**  
보기 : **Ctrl+Shift+K**  

```r
rm(list=ls())# 환경 청소 : list 설정
cat("\014")  # 콘솔 청소 : Ctrl + L
list.files(path=".", pattern = '.')  # 현제 폴더 파일일
```

-------------------------------------------------------------------------------


# 1. 데이터 전처리
1. [대여소 목록](https://data.seoul.go.kr/dataList/OA-13252/F/1/datasetView.do)  
엑셀에서 병합된 셀을 모두 해제하고 csv(UTF-8 쉼표로 분리)로 저장한다.  
해당 csv는 R에서 바로 읽히지 않는데, 이는 메모장에서 다른 이름으로 저장(ANSI로 인코딩)해야 R에서 읽힌다.


2. [따릉이 고장](https://data.seoul.go.kr/dataList/OA-15644/F/1/datasetView.do)   
2020.11.17에 수정된 최신 파일을 내려받는다.  
이 파일도 위와 같이 csv로 만든 후에 R에서 연다. 
```r
ID = read.csv("../공공자전거 대여소 정보(20.07.13 기준).csv")
Broken = read.csv('../서울시 공공자전거 고장신고 내역_2015_2020.10.csv')

names(ID)
# c("대여소.번호","보관소.대여소.명","자치구","상세주소","위도","경도","설치.시기","LCD","QR","운영.방식")     
names(Broken)
# c("자전거번호","등록일시","고장구분")
unique(Broken$고장구분)
#c("체인","기타 ","단말기","안장","페달","타이어 ","파손","잠금장치 불량")
```


### 1.1. 고장 데이터
자전거 번호 : SPB- 번호  
등록일시 : 2015-9-18(=0) 기준  
고장코드 :(1)체인,(2)기타, (3)단말기,(4)안장,(5)페달,(6)타이어,(7)파손,(8)잠금장치 불량

```r
date = as.Date('2015-9-18')
types = c("체인","기타 ","단말기","안장","페달","타이어 ","파손","잠금장치 불량")

BR = data.frame(bike = as.numeric(gsub('SPB-',"",Broken$자전거번호)),
                date = as.Date(substr(Broken$등록일시,1,10),'%Y-%m-%d')-date,
                type = factor(match(Broken$고장구분,types),labels =types))
write.csv(BR, file='Bike-Broken.csv.csv', row.names = FALSE)
```

### 1.2 자전거 데이터
자전거 번호 : SPB- 번호  
등록일시 : 2015-9-18(=0) 기준  
그외항목 : start(출발-대여소ID), end(반납-대여소ID), time(이동시간-분),  dist(이동거리-미터)


```r
# 폴더 내 파일 이름 검색
p = "../2015~2020_자전거 코드별 이용정보/"
f = list.files(path=p, pattern = '.csv') 

# 모든 파일 불러와서 병합
x = read.csv(paste0(p,f[1])) 
for (i in 2:length(f)){
  x = rbind(x,read.csv(paste0(p,f[i])))
}

# 필요한 열만 저장
date = as.Date('2015-9-18')
bike = x[,c(1,6,3,7,10,11)]
Bike = data.frame(bike = as.numeric(gsub('SPB-',"",bike$자전거번호)),
                date = as.Date(substr(bike$반납일시,1,10),'%Y-%m-%d')-date,
                start = bike$대여소번호, 
                end = bike$반납대여소번호,
                time = bike$이용시간.분.,
                dist = bike$이용거리.M.)
```

### 1.3 전처리 결과
#### 자전거 고장 : 파일 1개 (6MB) -> 1개(3.9MB)
#### 자전거 사용 : 파일 52개(5.2GB) -> 1개(56.8MB)
#### 파일 설명 : 
- 자전거 고장 : bike(자전거ID),date(접수일 2015.9.18일 +day), type(사유)
- 자전거 사용 : bike(자전거ID),date(반납일 2015.9.18일 +day),   
                start(출발-대여소ID), end(반납-대여소ID), time(이동시간-분),  dist(이동거리-미터)

```r
length(unique(sapply(BR$bike,as.character)))  ; length(BR[,1]) 
length(unique(sapply(Bike$bike,as.character))); length(Bike[,1])
# 고장 신고 : 181592 건
# 전체 이용 : 2043069건
# 고장 자전거 : 3400 대
# 전체 자전거 : 4971 대
```

-------------------------------------------------------------------------------

# 2. 데이터 둘러보기

### 2.1. 고장 사유빈도
가장 고장이 많이 가는 부분은 **1.단말기, 2.체인 3.기타 4.타이어** 순이다.

```{r echo=FALSE}
data.frame(t(summary(BR$type)))
```
```{r echo=FALSE}
plot(BR$type)

```
### 2.2 잘 고장나는 자전거


```r
library(dplyr)
friq = BR %>% count(bike) # 빈도 수 세기
friq = friq[order(friq$n,decreasing =TRUE),]

plot(friq,xlab = '자전거 일년번호', ylab='고장횟수')
plot(friq$n, xlab='고장 횟수로 정렬', ylab='고장 횟수')
```

#### 2.2.1. 오래된 자전거
따릉이 운영 초기(자전거 번호 낮음)부터 운영된 자전거의 고장 빈도가 높은 편이다.  
이는 자전거가 오래 운용될 수록 고장이 많이 난난다는 직관가 맞아 떨어진다. 

```{r echo=FALSE}
plot(friq,xlab = '자전거 번호', ylab='고장횟수')
```
#### 2.2.2 수리 후 잔고장
고장 빈도수를 기준으로 자전거ID의 순서를 정렬한 그래프다.  
이 그래프는 자전거가 얼마나 균형있게(?) 고장나는지를 보여준다.  
따릉이 사업이 확대됨에 따라 자전거의 개체수가 계단적으로 급증했음에도 의외로 고장 분포는 큰 step을 보이지는 않는다.
여기서 주목할 점은 자주 고장난 자전거 몇개가 지속적으로 고장나고 있다는 것이다.  
이는 수리를 해도 한 번 망가진 자전거는 다시 망가지기 쉽다는 것을 알려준다. 



```{r echo=FALSE}
plot(friq$n, xlab='고장 횟수로 정렬', ylab='고장 횟수')
```

